name: CD - Deploy to Self-Hosted Runner

# This workflow will be triggered in two ways:
on:
  # 1. Manually, with a "Run workflow" button in the Actions tab
  workflow_dispatch:

  # 2. Automatically, when the "CI - Build and Push" workflow finishes
  workflow_run:
    workflows: ["CI - Build and Push Docker Images"] # Name of your other file
    types:
      - completed # Run only when it's 'completed'
    branches:
      - main

jobs:
  deploy:
    # --- THIS IS THE MAGIC ---
    # This job will ONLY run if the CI workflow was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    # --- THIS IS THE KEY ---
    # This job will *wait* for a runner with the 'self-hosted' label
    runs-on: self-hosted

    # Set the same env variables as our CI build
    env:
      REGISTRY: ghcr.io
      IMAGE_OWNER: ${{ vars.IMAGE_OWNER || 'sebastiendesalle' }}
      REPO_NAME: ${{ vars.REPO_NAME || 'trainingdevopsplan' }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull new images from GHCR
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-web:latest
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-api:latest
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.REPO_NAME }}-worker:latest

      - name: Stop and restart services with new images
        run: |
          docker-compose up -d --force-recreate
          docker image prune -f
